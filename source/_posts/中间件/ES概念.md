# 1、ES基本概念

## 1.1 ES是什么

ES是一个可高度扩展的全文搜索和分析引擎。它能够快速地、近乎实时地存储、查询和分析大量数据。

- 一个分布式的实时文档存储，每个字段可以被索引与搜索
- 一个分布式实时分析搜索引擎
- 能胜任上百个服务节点的扩展，并支持 PB 级别的结构化或者非结构化数据
- 基于Lucene，隐藏复杂性，提供简单易用的Restful API接口、Java API接口（还有其他语言的API接口）。

## 1.2 ES常用名词含义说明

- 集群（cluster）：ES集群由若干节点组成，这些节点在同一个网络内，cluster-name相同
- 节点（node）：一个ES的实例，本质上是一个java进程，生产环境一般建议一台机器上运行一个ES实例

- master节点：集群中的一个节点会被选为master节点，它将**负责管理集群范畴的变更，例如创建或删除索引，添加节点到集群或从集群删除节点**。master节点**无需参与文档层面的变更和搜索**，这意味着仅有一个master节点并不会因流量增长而成为瓶颈。任意一个节点都可以成为 master 节点，设置node.master为true。
- data节点：持有数据和倒排索引。默认情况下，每个节点都可以通过设定配置文件中的node.data属性为true(默认)成为数据节点。如果需要一个专门的主节点，应将其node.data属性设置为false。
- client节点：如果将node.master属性和node.data属性都设置为false，那么该节点就是一个客户端节点，扮演一个负载均衡的角色，将到来的请求路由到集群中的各个节点。

- 索引（index）：文档的容器，一类文档的集合
- 分片（shard）：单个节点由于物理机硬件限制，存储的文档是有限的，如果一个索引包含海量文档，则不能在单个节点存储。ES提供分片机制，同一个索引可以存储在不同分片（数据容器）中，这些分片又可以存储在集群中不同节点上。
  - 主分片（primary shard）：主分片的数量在索引创建后就固定下来了
  - 从分片（replica shard）：为主分片的一个副本，提供数据的冗余副本，在出现故障时提供数据保护，同时服务于搜索和检索这种只读请求。数量可以随时改变

分片的重要性：

- 可以水平分割或扩展内容体量。
- 可以分布式和并行的方式在多个分片上进行操作（多个节点）从而提高性能和吞吐量。

副本（Replicas）的重要性：

- 当一个分片或者节点出错时，集群仍然可用。正因如此，我们会发现一个分片副本从来不会在它的原始分片或主分片所在的节点出现。
- 横向扩展搜索体量和吞吐量，因为搜索可以在所有副本上并行执行。

- 文档（document）：可搜索的最小单元 ，json格式保存



每个ES分片都是一个Lucene索引。对于单个Lucene索引，文档的最大数有一个限制，2,147,483,519。即(= Integer.MAX_VALUE - 128)



## 1.3 ES与关系型数据库类比

在ES 6.X之前有Type（类型）对应关系型数据库中的表，但之后一个index中只能包含一个Type，在ES 7.X后Type的概念就被删除了

RDBMSESTableIndexRowDocumentColumnFieldSchemaMappingSQLDSL



# 2、ES索引结构

1、一个索引由多个段文件构成

2、一个段文件是一个完整的Lucene索引

3、段文件中的核心数据结构：倒排索引、正排索引、

## 倒排索引（invert index）

用来存储在全文搜索下某个单词在一个文档或者一组文档中的存储位置的映射



倒排索引被写入磁盘后是不可改变的：它永远不会修改。 不变性有重要的价值：

1、不需要锁。如果你从来不更新索引，你就不需要担心多进程同时修改数据的问题。

2、一旦索引被读入内核的文件系统缓存，便会留在哪里，由于其不变性。只要文件系统缓存中还有足够的空间，那么大部分读请求会直接请求内存，而不会命中磁盘。这提供了很大的性能提升。

3、其它缓存(像filter缓存)，在索引的生命周期内始终有效。它们不需要在每次数据改变时被重建，因为数据不会变化。

4、写入单个大的倒排索引允许数据被压缩，减少磁盘 I/O 和 需要被缓存到内存的索引的使用量。



## 正排索引（）



# ES写入原理



translog：即数据索引前，会先写入到日志文件中。假如节点挂了，重启节点时就会重放日志，这样相当于把用户的操作模拟了一遍。保证了数据的不丢失（将没有提交的索引操作以持久化的方式记录起来）



# ES查询原理

















[JAVA Client API使用示例](https://km.sankuai.com/page/841605641)

ES 反序列化抽象类：MoneyEagleIndex（waimai_service_money_bill_server）    可分析学习