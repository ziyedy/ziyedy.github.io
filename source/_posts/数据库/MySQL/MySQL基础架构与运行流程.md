---
title: MySQL基础架构与运行流程
date: 2021-04-11 21:37:11
tags:
    - MySQL
categories:
	- 数据库
    - MySQL
fileName: mysql-basic-and-process
---

## 数据库

随着应用程序功能越来越复杂以及数据量越来越大，数据库作为一种专门管理数据的软件就出现了

### 基本架构

Mysql大致可以分为Server层、存储引擎层

* Server层包括连接器、查询缓存（在 MySQL 8.0.3 中删除）、分析器、优化器、执行器等，涵盖MySQL的大多数核心服务功能，以及所有的内置函数（如日期、时间、数学和加密函数等），所有跨存储引擎的功能都在这一层实现，比如存储过程、触发器、视图等。

* 存储引擎层负责数据的存储和提取。其架构模式是插件式的，支持InnoDB、MyISAM、Memory等多个存储引擎。现在最常用的存储引擎是InnoDB，它从MySQL 5.5.5版本开始成为了默认存储引擎。



## 查询语句执行流程

### 连接器

连接器负责跟客户端建立连接、获取权限、维持和管理连接

### 查询缓存

*不建议使用，命中率极低！目前已经被删除了*

MySQL拿到一个查询请求后，会先到查询缓存看看，之前是不是执行过这条语句。之前执行过的语句及其结果可能会以key-value对的形式，被直接缓存在内存中。key是查询的语句，value是查询的结果。如果你的查询能够直接在这个缓存中找到key，那么这个value就会被直接返回给客户端。

MySQL 8.0版本直接将查询缓存的整块功能删掉了

### 分析器

对SQL进行词法分析、语法分析

### 优化器

优化器是在表里面有多个索引的时候，决定使用哪个索引；或者在一个语句有多表关联（join）的时候，决定各个表的连接顺序。

### 执行器

判断有没有权限，有的话则调用引擎提供的接口进行执行，有索引的话走索引
例：

```sql
select * from Test where a=1 and b=1;
```

如果走索引b：则先调用存储引擎的接口获取满足条件b=1的记录返回给执行器，然后执行器再判断a是不是等于1，如果相等则放入结果集。循环该过程直到遍历循环结束，之后执行器将结果返回客户端



## 更新语句执行流程

以以下语句为例

```sql
update Test set a=a+1 where id=2;
```

1、首先走查询语句的整个流程找到数据

2、执行器找到id=2的记录，并将该记录的a加一，再调用引擎接口写入这行新数据

3、引擎将这行新数据更新到内存中，同时将这个更新操作记录到redo log里面，此时redo log处于prepare状态。然后告知执行器执行完成了，随时可以提交事务

4、执行器生成该操作的binlog，并将binlog写入磁盘

5、执行器调用引擎的提交事务接口，将刚刚写入的redo log改成提交（commit）状态，更新完成

### 注意点

1、redo log的两阶段提交，即将redo log的写入拆成了两个步骤：prepare与commit。

两阶段提交是为了保证两份日志之间的逻辑一致性





