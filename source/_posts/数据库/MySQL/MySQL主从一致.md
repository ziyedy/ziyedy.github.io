## 主从架构

单台MySQL无法满足高可用与高并发等生产环境：因此，通常*通过主从复制（master-slave）来同步数据，而通过读写分离来提升数据库的并发负载能力*

MySQL主从集群的作用：

* 提高数据库负载能力（主库执行读写任务，从库仅做查询）
* 提高系统读写性能、可拓展性与高可用性
* 数据备份与容灾（主库出现问题，备库可以立刻接管，无需恢复时间）



## 主从同步

### 三个线程

MySQL主从同步主要有三个线程：master（binlog dump thread）；slave（I/O thread、SQL thread）

* binlog dump thread：主库中有数据更新时，根据设置的binlog格式，将更新的事件类型写入到主库的binlog文件中，并创建log dump线程通知slave有数据更新。当I/O线程请求日志内容时，将此时的binlog名称和当前更新的位置同时传给slave的I/O线程
* I/O线程：该线程会连接到master，向log dump线程请求一份*指定binlog文件位置*的副本，并将请求回来的binlog存到本地的relay log中（因此MySQL主从同步是从库从主库**拉取**binlog信息）
* SQL线程：该线程检测到relay log有更新后，会读取并在本地做redo操作，将发生在主库的事件在本地重新执行一遍，来保证主从数据同步

### 应用

可以通过MySQL主从同步的机制，将server伪装成一个MySQL slave，从而通过MySQL主从同步拉到数据，实时获得数据库的变更并通过消息发送出来，供各业务线订阅（该应用在如今互联网技术中很广泛，可以用于数据同步、数据监控等多种操作）



## 主从延迟

1. 主库A执行完成一个事务，写入binlog，我们把这个时刻记为T1;
2. 之后传给备库B，我们把备库B接收完这个binlog的时刻记为T2;
3. 备库B执行完成这个事务，我们把这个时刻记为T3。

此时 T3 - T1 即为主从延迟时间（主要耗时为T3-T2，即从库消耗中转日志的时间）

### 主从延迟来源与解决方案

* 备库所在机器性能较差
* 备库承担的压力大（由于不直接影响业务，因此用来承担一些运营分析等操作带来的读能力，有时候承受的压力反而大）
  * 一主多从
  * 通过binlog输出到外部系统，让外部系统提供相应查询能力
* 大事务。主库必须等事务执行完成后才写入binlog传给从库。因此如果一个事务在主库上执行的时间很长，那么其在从库上也会执行很长时间，造成主从延迟
  * 因此在执行delete语句时应当避免一次性删除大量语句，尽可能分批次进行（实习中也确实是这样的，执行一次会休眠一段时间）

